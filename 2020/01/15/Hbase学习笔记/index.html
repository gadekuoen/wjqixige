<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/wjqixige/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/wjqixige/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/wjqixige/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/wjqixige/images/logo.svg" color="#222">

<link rel="stylesheet" href="/wjqixige/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="next-config" data-name="main" type="application/json">{&quot;hostname&quot;:&quot;gadekuoen.github.io&quot;,&quot;root&quot;:&quot;&#x2F;wjqixige&#x2F;&quot;,&quot;images&quot;:&quot;&#x2F;wjqixige&#x2F;images&quot;,&quot;scheme&quot;:&quot;Gemini&quot;,&quot;version&quot;:&quot;8.3.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:false,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:false,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:true,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;搜索...&quot;,&quot;empty&quot;:&quot;没有找到任何搜索结果：${query}&quot;,&quot;hits_time&quot;:&quot;找到 ${hits} 个搜索结果（用时 ${time} 毫秒）&quot;,&quot;hits&quot;:&quot;找到 ${hits} 个搜索结果&quot;}}</script>
<meta name="description" content="hbase是基于Google BigTable模型开发的，典型的key&#x2F;value系统。是建立在hdfs之上，提供高可靠性、高性能、列存储、可伸缩、实时读写nosql的数据库系统。它是Apache Hadoop生态系统中的重要一员，主要用于海量结构化和半结构化数据存储。 它介于nosql和RDBMS之间，仅能通过主键(row key)和主键的range来检索数据，仅支持单行事务(可通过hive支持">
<meta property="og:type" content="article">
<meta property="og:title" content="Hbase学习笔记">
<meta property="og:url" content="https://gadekuoen.github.io/wjqixige/2020/01/15/Hbase%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="栖溪阁晓生">
<meta property="og:description" content="hbase是基于Google BigTable模型开发的，典型的key&#x2F;value系统。是建立在hdfs之上，提供高可靠性、高性能、列存储、可伸缩、实时读写nosql的数据库系统。它是Apache Hadoop生态系统中的重要一员，主要用于海量结构化和半结构化数据存储。 它介于nosql和RDBMS之间，仅能通过主键(row key)和主键的range来检索数据，仅支持单行事务(可通过hive支持">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-01-15T14:44:11.000Z">
<meta property="article:modified_time" content="2020-01-15T14:54:11.877Z">
<meta property="article:author" content="Mr.wj">
<meta property="article:tag" content="hbase">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://gadekuoen.github.io/wjqixige/2020/01/15/Hbase%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">



<script class="next-config" data-name="page" type="application/json">{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:false,&quot;isPost&quot;:true,&quot;lang&quot;:&quot;zh-CN&quot;,&quot;comments&quot;:true,&quot;permalink&quot;:&quot;https:&#x2F;&#x2F;gadekuoen.github.io&#x2F;wjqixige&#x2F;2020&#x2F;01&#x2F;15&#x2F;Hbase%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0&#x2F;&quot;,&quot;path&quot;:&quot;2020&#x2F;01&#x2F;15&#x2F;Hbase学习笔记&#x2F;&quot;,&quot;title&quot;:&quot;Hbase学习笔记&quot;}</script>

<script class="next-config" data-name="calendar" type="application/json">&quot;&quot;</script>
<title>Hbase学习笔记 | 栖溪阁晓生</title><script src="/wjqixige/js/config.js"></script>
  




  <noscript>
    <link rel="stylesheet" href="/wjqixige/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/wjqixige/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">栖溪阁晓生</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">个人在线笔记本</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/wjqixige/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/wjqixige/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/wjqixige/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/wjqixige/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/wjqixige/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-commonweal"><a href="/wjqixige/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#HBase%E7%89%B9%E5%BE%81"><span class="nav-text">HBase特征</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hbase%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="nav-text">hbase集群搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E4%B8%8B%E8%BD%BDhbase%E5%AE%89%E8%A3%85%E5%8C%85"><span class="nav-text">第一步：下载hbase安装包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E5%8E%8B%E7%BC%A9%E5%8C%85%E4%B8%8A%E4%BC%A0%E5%B9%B6%E8%A7%A3%E5%8E%8B"><span class="nav-text">第二步：压缩包上传并解压</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">第三步：修改配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E7%AC%AC%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6hbase-env-sh"><span class="nav-text">修改第一个配置文件hbase-env.sh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E7%AC%AC%E4%BA%8C%E4%B8%AA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6hbase-site-xml"><span class="nav-text">修改第二个配置文件hbase-site.xml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E7%AC%AC%E4%B8%89%E4%B8%AA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6regionservers"><span class="nav-text">修改第三个配置文件regionservers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAback-masters%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%EF%BC%8C%E5%AE%9E%E7%8E%B0HMaster%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-text">创建back-masters配置文件，实现HMaster的高可用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E5%AE%89%E8%A3%85%E5%8C%85%E5%88%86%E5%8F%91%E5%88%B0%E5%85%B6%E4%BB%96%E6%9C%BA%E5%99%A8"><span class="nav-text">第四步：安装包分发到其他机器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%9A%E4%B8%89%E5%8F%B0%E6%9C%BA%E5%99%A8%E5%88%9B%E5%BB%BA%E8%BD%AF%E8%BF%9E%E6%8E%A5"><span class="nav-text">第五步：三台机器创建软连接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%85%AD%E6%AD%A5%EF%BC%9A%E4%B8%89%E5%8F%B0%E6%9C%BA%E5%99%A8%E6%B7%BB%E5%8A%A0HBASE-HOME%E7%9A%84%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-text">第六步：三台机器添加HBASE_HOME的环境变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%83%E6%AD%A5%EF%BC%9Ahbase%E9%9B%86%E7%BE%A4%E5%90%AF%E5%8A%A8"><span class="nav-text">第七步：hbase集群启动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%85%AB%E6%AD%A5%EF%BC%9A%E9%A1%B5%E9%9D%A2%E8%AE%BF%E9%97%AE"><span class="nav-text">第八步：页面访问</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Hbase%E7%9A%84%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86"><span class="nav-text">Hbase的底层原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#hbase%E7%9A%84%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84"><span class="nav-text">hbase的基础架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A1%A8%E7%BB%93%E6%9E%84%E9%80%BB%E8%BE%91%E8%A7%86%E5%9B%BE"><span class="nav-text">表结构逻辑视图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%89%A9%E7%90%86%E5%AD%98%E5%82%A8"><span class="nav-text">物理存储</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84"><span class="nav-text">整体结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#STORE-FILE-amp-HFILE%E7%BB%93%E6%9E%84"><span class="nav-text">STORE FILE &amp; HFILE结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#memstore%E4%B8%8Estorefile"><span class="nav-text">memstore与storefile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HLog-WAL-log"><span class="nav-text">HLog(WAL log)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%BB%E5%86%99%E8%BF%87%E7%A8%8B"><span class="nav-text">读写过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%BB%E8%AF%B7%E6%B1%82%E8%BF%87%E7%A8%8B"><span class="nav-text">读请求过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%99%E8%AF%B7%E6%B1%82%E8%BF%87%E7%A8%8B"><span class="nav-text">写请求过程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Region%E7%AE%A1%E7%90%86"><span class="nav-text">Region管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Master%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6"><span class="nav-text">Master工作机制</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#HBase%E4%B8%89%E4%B8%AA%E9%87%8D%E8%A6%81%E6%9C%BA%E5%88%B6"><span class="nav-text">HBase三个重要机制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#flush%E6%9C%BA%E5%88%B6"><span class="nav-text">flush机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#compact%E6%9C%BA%E5%88%B6"><span class="nav-text">compact机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#split%E6%9C%BA%E5%88%B6"><span class="nav-text">split机制</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#HBase%E7%9A%84rowkey%E8%AE%BE%E8%AE%A1%E6%8A%80%E5%B7%A7"><span class="nav-text">HBase的rowkey设计技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#rowkey%E9%95%BF%E5%BA%A6%E5%8E%9F%E5%88%99"><span class="nav-text">rowkey长度原则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rowkey%E6%95%A3%E5%88%97%E5%8E%9F%E5%88%99"><span class="nav-text">rowkey散列原则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rowkey%E5%94%AF%E4%B8%80%E5%8E%9F%E5%88%99"><span class="nav-text">rowkey唯一原则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%83%AD%E7%82%B9"><span class="nav-text">什么是热点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A0%E7%9B%90"><span class="nav-text">加盐</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%93%88%E5%B8%8C"><span class="nav-text">哈希</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8D%E8%BD%AC"><span class="nav-text">反转</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E6%88%B3%E5%8F%8D%E8%BD%AC"><span class="nav-text">时间戳反转</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <a href="/"><img class="site-author-image" itemprop="image" alt="Mr.wj" src="/wjqixige/uploads/logo.jpg"></a>
  <p class="site-author-name" itemprop="name">Mr.wj</p>
  <div class="site-description" itemprop="description">记录和分享我学习是记录的笔记和个人想法</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/wjqixige/archives/">
        
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">33</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/gadekuoen/wjqixige" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;gadekuoen&#x2F;wjqixige" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/wjqixige/wujiang569@126.com" title="E-Mail → wujiang569@126.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://gadekuoen.github.io/wjqixige/2020/01/15/Hbase%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/wjqixige/uploads/logo.jpg">
      <meta itemprop="name" content="Mr.wj">
      <meta itemprop="description" content="记录和分享我学习是记录的笔记和个人想法">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="栖溪阁晓生">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Hbase学习笔记
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2020-01-15 22:44:11 / 修改时间：22:54:11" itemprop="dateCreated datePublished" datetime="2020-01-15T22:44:11+08:00">2020-01-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/wjqixige/categories/Hbase/" itemprop="url" rel="index"><span itemprop="name">Hbase</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>hbase是基于Google BigTable模型开发的，典型的key/value系统。是建立在hdfs之上，提供高可靠性、高性能、列存储、可伸缩、实时读写nosql的数据库系统。它是Apache Hadoop生态系统中的重要一员，主要用于海量结构化和半结构化数据存储。</p>
<p>它介于nosql和RDBMS之间，仅能通过主键(row key)和主键的range来检索数据，仅支持单行事务(可通过hive支持来实现多表join等复杂操作)。</p>
<p>Hbase查询数据功能很简单，不支持join等复杂操作，不支持复杂的事务（行级的事务）与hadoop一样，Hbase目标主要依靠横向扩展，通过不断增加廉价的商用服务器，来增加计算和存储能力。</p>
<span id="more"></span>

<h1 id="HBase特征"><a href="#HBase特征" class="headerlink" title="HBase特征"></a>HBase特征</h1><p><strong>海量存储</strong></p>
<p>Hbase适合存储PB级别的海量数据，在PB级别的数据以及采用廉价PC存储的情况下，能在几十到百毫秒内返回数据。这与Hbase的极易扩展性息息相关。正式因为Hbase良好的扩展性，才为海量数据的存储提供了便利。</p>
<p><strong>列式存储</strong></p>
<p>这里的列式存储其实说的是列族存储，Hbase是根据列族来存储数据的。列族下面可以有非常多的列，列族在创建表的时候就必须指定。</p>
<p><strong>极易扩展</strong></p>
<p>Hbase的扩展性主要体现在两个方面，一个是基于上层处理能力（RegionServer）的扩展，一个是基于存储的扩展（HDFS）。<br> 通过横向添加RegionSever的机器，进行水平扩展，提升Hbase上层的处理能力，提升Hbsae服务更多Region的能力。</p>
<p>备注：RegionServer的作用是管理region、承接业务的访问，这个后面会详细的介绍通过横向添加Datanode的机器，进行存储层扩容，提升Hbase的数据存储能力和提升后端存储的读写能力。</p>
<p><strong>高并发</strong></p>
<p>由于目前大部分使用Hbase的架构，都是采用的廉价PC，因此单个IO的延迟其实并不小，一般在几十到上百ms之间。这里说的高并发，主要是在并发的情况下，Hbase的单个IO延迟下降并不多。能获得高并发、低延迟的服务。</p>
<p><strong>稀疏</strong></p>
<p>稀疏主要是针对Hbase列的灵活性，在列族中，你可以指定任意多的列，在列数据为空的情况下，是不会占用存储空间的。</p>
<h1 id="hbase集群搭建"><a href="#hbase集群搭建" class="headerlink" title="hbase集群搭建"></a>hbase集群搭建</h1><table>
<thead>
<tr>
<th>IP服务器</th>
<th>node01</th>
<th>node02</th>
<th>node03</th>
</tr>
</thead>
<tbody><tr>
<td>Hbase</td>
<td>HMaster,HRegionServer</td>
<td>HMaster,HRegionServer</td>
<td>HRegionServer</td>
</tr>
</tbody></table>
<p>注意事项：hbase强依赖于HDFS和zookeeper，所以安装Hbase之前一定要保证hadoop和zookeeper正常启动。</p>
<h2 id="第一步：下载hbase安装包"><a href="#第一步：下载hbase安装包" class="headerlink" title="第一步：下载hbase安装包"></a>第一步：下载hbase安装包</h2><p><a target="_blank" rel="noopener" href="http://archive.apache.org/dist/hbase/2.0.0/hbase-2.0.0-bin.tar.gz">http://archive.apache.org/dist/hbase/2.0.0/hbase-2.0.0-bin.tar.gz</a></p>
<h2 id="第二步：压缩包上传并解压"><a href="#第二步：压缩包上传并解压" class="headerlink" title="第二步：压缩包上传并解压"></a>第二步：压缩包上传并解压</h2><p>将我们的压缩包上传到node01服务器的/export/softwares路径下并解压</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /<span class="built_in">export</span>/softwares</span><br><span class="line">tar -zxvf hbase-2.0.0-bin.tar.gz -C /<span class="built_in">export</span>/servers/</span><br></pre></td></tr></table></figure>

<h2 id="第三步：修改配置文件"><a href="#第三步：修改配置文件" class="headerlink" title="第三步：修改配置文件"></a>第三步：修改配置文件</h2><p>node01机器进行修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /<span class="built_in">export</span>/servers/hbase-2.0.0/conf</span><br></pre></td></tr></table></figure>

<h3 id="修改第一个配置文件hbase-env-sh"><a href="#修改第一个配置文件hbase-env-sh" class="headerlink" title="修改第一个配置文件hbase-env.sh"></a>修改第一个配置文件<code>hbase-env.sh</code></h3><p>node01机器进行修改配置文件</p>
<p>注释掉hbase使用内部zookeeper</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /<span class="built_in">export</span>/servers/hbase-2.0.0/conf</span><br><span class="line">vim hbase-env.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">export</span> <span class="string">JAVA_HOME=/export/servers/jdk1.8.0_141</span></span><br><span class="line"><span class="attr">export</span> <span class="string">HBASE_MANAGES_ZK=false</span></span><br></pre></td></tr></table></figure>

<h3 id="修改第二个配置文件hbase-site-xml"><a href="#修改第二个配置文件hbase-site-xml" class="headerlink" title="修改第二个配置文件hbase-site.xml"></a>修改第二个配置文件<code>hbase-site.xml</code></h3><p>node01机器进行修改文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /<span class="built_in">export</span>/servers/hbase-2.0.0/conf</span><br><span class="line">vim hbase-site.xml</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.rootdir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://node01:8020/hbase<span class="tag">&lt;/<span class="name">value</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.cluster.distributed<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">&lt;!-- 0.98后的新变动，之前版本没有.port,默认端口为60000 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.master.port<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>16000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>node01:2181,node02:2181,node03:2181<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.property.dataDir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">value</span>&gt;</span>/export/servers/zookeeper-3.4.9/zkdatas<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="修改第三个配置文件regionservers"><a href="#修改第三个配置文件regionservers" class="headerlink" title="修改第三个配置文件regionservers"></a>修改第三个配置文件<code>regionservers</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /<span class="built_in">export</span>/servers/hbase-2.0.0/conf</span><br><span class="line">vim regionservers</span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">node01</span></span><br><span class="line"><span class="attr">node02</span></span><br><span class="line"><span class="attr">node03</span></span><br></pre></td></tr></table></figure>

<h3 id="创建back-masters配置文件，实现HMaster的高可用"><a href="#创建back-masters配置文件，实现HMaster的高可用" class="headerlink" title="创建back-masters配置文件，实现HMaster的高可用"></a>创建<code>back-masters</code>配置文件，实现<code>HMaster</code>的高可用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /<span class="built_in">export</span>/servers/hbase-2.0.0/conf</span><br><span class="line">vim backup-masters</span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">node02</span></span><br></pre></td></tr></table></figure>

<h2 id="第四步：安装包分发到其他机器"><a href="#第四步：安装包分发到其他机器" class="headerlink" title="第四步：安装包分发到其他机器"></a>第四步：安装包分发到其他机器</h2><p>将我们node01服务器的hbase的安装包拷贝到其他机器上面去</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /<span class="built_in">export</span>/servers</span><br><span class="line">scp -r hbase-2.0.0/ node02:<span class="variable">$PWD</span></span><br><span class="line">scp -r hbase-2.0.0/ node03:<span class="variable">$PWD</span></span><br></pre></td></tr></table></figure>

<h2 id="第五步：三台机器创建软连接"><a href="#第五步：三台机器创建软连接" class="headerlink" title="第五步：三台机器创建软连接"></a>第五步：三台机器创建软连接</h2><p>因为hbase需要读取hadoop的<code>core-site.xml</code>以及<code>hdfs-site.xml</code>当中的配置文件信息，所以<strong>三台机器</strong>都要执行以下命令创建软连接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /<span class="built_in">export</span>/servers/hadoop-2.7.5/etc/hadoop/core-site.xml /<span class="built_in">export</span>/servers/hbase-2.0.0/conf/core-site.xml</span><br><span class="line">ln -s /<span class="built_in">export</span>/servers/hadoop-2.7.5/etc/hadoop/hdfs-site.xml /<span class="built_in">export</span>/servers/hbase-2.0.0/conf/hdfs-site.xml</span><br></pre></td></tr></table></figure>

<h2 id="第六步：三台机器添加HBASE-HOME的环境变量"><a href="#第六步：三台机器添加HBASE-HOME的环境变量" class="headerlink" title="第六步：三台机器添加HBASE_HOME的环境变量"></a>第六步：三台机器添加<code>HBASE_HOME</code>的环境变量</h2><p><strong>三台机器</strong>执行以下命令，添加HBASE_HOME环境变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">export</span> <span class="string">HBASE_HOME=/export/servers/hbase-2.0.0</span></span><br><span class="line"><span class="attr">export</span> <span class="string">PATH=:$HBASE_HOME/bin:$PATH</span></span><br></pre></td></tr></table></figure>

<h2 id="第七步：hbase集群启动"><a href="#第七步：hbase集群启动" class="headerlink" title="第七步：hbase集群启动"></a>第七步：hbase集群启动</h2><p>第一台机器执行以下命令进行启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /<span class="built_in">export</span>/servers/hbase-2.0.0</span><br><span class="line">bin/start-hbase.sh</span><br></pre></td></tr></table></figure>

<p><strong>警告提示</strong>：HBase启动的时候会产生一个警告，这是因为jdk7与jdk8的问题导致的，如果linux服务器安装jdk8就会产生这样的一个警告  </p>
<p>我们可以只是删掉所有机器的hbase-env.sh当中的“HBASE_MASTER_OPTS”和“HBASE_REGIONSERVER_OPTS”配置 来解决这个问题。不过警告不影响我们正常运行，可以不用解决</p>
<p>另外一种启动方式：</p>
<p>我们也可以执行以下命令单节点进行启动</p>
<p>启动HMaster命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/hbase-daemon.sh start master</span><br></pre></td></tr></table></figure>

<p>启动HRegionServer命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/hbase-daemon.sh start regionserver</span><br></pre></td></tr></table></figure>

<h2 id="第八步：页面访问"><a href="#第八步：页面访问" class="headerlink" title="第八步：页面访问"></a>第八步：页面访问</h2><p>浏览器页面访问 <a target="_blank" rel="noopener" href="http://node01:16010/master-status">http://node01:16010/master-status</a></p>
<h1 id="Hbase的底层原理"><a href="#Hbase的底层原理" class="headerlink" title="Hbase的底层原理"></a>Hbase的底层原理</h1><h2 id="hbase的基础架构"><a href="#hbase的基础架构" class="headerlink" title="hbase的基础架构"></a>hbase的基础架构</h2>

<ul>
<li><p><strong>Client</strong>：包含访问hbase的接口，client维护着一些cache来加快对hbase的访问，比如regione的位置信息；</p>
</li>
<li><p><strong>Zookeeper</strong>：</p>
<ol>
<li><p>保证任何时候，集群中只有一个master</p>
</li>
<li><p>存贮所有Region的寻址入口</p>
</li>
<li><p>实时监控Region Server的状态，将Region server的上线和下线信息实时通知给Master</p>
</li>
<li><p>存储Hbase的schema,包括有哪些table，每个table有哪些column family</p>
</li>
</ol>
</li>
<li><p><strong>HMaster</strong>：主节点</p>
<ol>
<li><p>为Region server分配region</p>
</li>
<li><p>负责region server的负载均衡</p>
</li>
<li><p>发现失效的region server并重新分配其上的region</p>
</li>
<li><p>HDFS上的垃圾文件回收</p>
</li>
<li><p>处理schema更新请求</p>
</li>
</ol>
</li>
<li><p><strong>HRegionServer</strong>：</p>
<ol>
<li><p>Region server维护Master分配给它的region，处理对这些region的IO请求</p>
</li>
<li><p>Region server负责切分在运行过程中变得过大的region</p>
</li>
</ol>
<p>可以看到，client访问hbase上数据的过程并不需要master参与（寻址访问zookeeper和region server，数据读写访问regione server），master仅仅维护者table和region的元数据信息，负载很低。</p>
</li>
<li><p><strong>Region</strong>：hbase表中分布式存储的最小单元。Hbase表的分片，HBase表会根据RowKey值被切分成不同的region存储在RegionServer中，在一个RegionServer中可以有多个不同的region。</p>
</li>
<li><p><strong>Write-Ahead logs</strong></p>
<p>HBase的修改记录，当对HBase读写数据的时候，数据不是直接写进磁盘，它会在内存中保留一段时间（时间以及数据量阈值可以设定）。但把数据保存在内存中可能有更高的概率引起数据丢失，为了解决这个问题，数据会先写在一个叫做Write-Ahead logfile的文件中，然后再写入内存中。所以在系统出现故障的时候，数据可以通过这个日志文件重建。</p>
</li>
<li><p><strong>HFile</strong>：这是在磁盘上保存原始数据的实际的物理文件，是实际的存储文件。</p>
</li>
<li><p><strong>Store</strong>：HFile存储在Store中，一个Store对应HBase表中的一个列族。</p>
</li>
<li><p><strong>MemStore</strong>：顾名思义，就是内存存储，位于内存中，用来保存当前的数据操作，所以当数据保存在WAL中之后，RegsionServer会在内存中存储键值对。</p>
</li>
</ul>
<h2 id="表结构逻辑视图"><a href="#表结构逻辑视图" class="headerlink" title="表结构逻辑视图"></a>表结构逻辑视图</h2><p>Hbase以表的形式存储数据。表有行和列组成。列划分为若干个列族（column family）</p>


<p><strong>Row Key</strong></p>
<p>与nosql数据库一样，row key是用来检索记录的主键。访问hbase table中的行，只有三种方式：</p>
<ol>
<li>通过单个row key访问n</li>
<li>通过row key的range</li>
<li>全表扫描</li>
</ol>
<p>Row key行键 (Row key)可以是任意字符串(最大长度是 64KB，实际应用中长度一般为 10-100bytes)，在hbase内部，row key保存为字节数组。</p>
<p>hbase会对表中的数据按照rowkey排序（字典顺序）</p>
<p>存储时，数据按照Row key的字典序排序存储。设计key时，要充分排序存储这个特性，将经常一起读取的行存储放到一起。</p>
<p><strong>列族</strong></p>
<p>hbase表中的每个列，都归属于某个列族。列族是表的schema的一部分（而列不是），必须再使用表之前定义。</p>
<p>列名都是以列族作为前缀。例如：courses:history, courses:math都属于courses这个列族。</p>
<p>访问控制、磁盘和内存的使用统计都是在列族层面进行的。列族越多，在取一行数据时要参与IO、搜寻的文件就越多，所以，如果没有必要，不要设置太多的列族。</p>
<p><strong>时间戳</strong></p>
<p>HBase中通过row和columns确定的为一个存贮单元称为cell。每个 cell都保存着同一份数据的多个版本。版本通过时间戳来索引。时间戳的类型是 64位整型。时间戳可以由hbase(在数据写入时自动 )赋值，此时时间戳是精确到毫秒的当前系统时间。时间戳也可以由客户显式赋值。如果应用程序要避免数据版本冲突，就必须自己生成具有唯一性的时间戳。每个 cell中，不同版本的数据按照时间倒序排序，即最新的数据排在最前面。</p>
<p>为了避免数据存在过多版本造成的的管理 (包括存贮和索引)负担，hbase提供了两种数据版本回收方式：</p>
<ul>
<li><p>保存数据的最后n个版本</p>
</li>
<li><p>保存最近一段时间内的版本（设置数据的生命周期TTL）。</p>
</li>
</ul>
<p>用户可以针对每个列族进行设置。</p>
<p><strong>Cell</strong></p>
<p>由{row key, column( =&lt;family&gt; + &lt;label&gt;), version} 唯一确定的单元。</p>
<p>cell中的数据是没有类型的，全部是字节码形式存贮。</p>
<p><strong>VersionNum</strong></p>
<p>数据的版本号，每条数据可以有多个版本号，默认值为系统时间戳，类型为Long。</p>
<h2 id="物理存储"><a href="#物理存储" class="headerlink" title="物理存储"></a>物理存储</h2><h3 id="整体结构"><a href="#整体结构" class="headerlink" title="整体结构"></a>整体结构</h3>

<ol>
<li><p>Table中的所有行都按照row key的字典序排列。</p>
</li>
<li><p>Table 在行的方向上分割为多个Hregion。</p>
</li>
<li><p>region按大小分割的(默认10G)，每个表一开始只有一个region，随着数据不断插入表，region不断增大，当增大到一个阀值的时候，Hregion就会等分为两个新的Hregion。当table中的行不断增多，就会有越来越多的Hregion。</p>
</li>
<li><p>Hregion是Hbase中分布式存储和负载均衡的最小单元。最小单元就表示不同的Hregion可以分布在不同的HRegion server上。但一个Hregion是不会拆分到多个server上的。</p>
</li>
<li><p>HRegion虽然是负载均衡的最小单元，但并不是物理存储的最小单元。事实上，HRegion由一个或者多个Store组成，每个store保存一个column family。每个Strore又由一个memStore和0至多个StoreFile组成。</p>
</li>
</ol>
<h3 id="STORE-FILE-amp-HFILE结构"><a href="#STORE-FILE-amp-HFILE结构" class="headerlink" title="STORE FILE &amp; HFILE结构"></a>STORE FILE &amp; HFILE结构</h3><p>StoreFile以HFile格式保存在HDFS上。HFile的格式如图：</p>


<p>首先HFile文件是不定长的，长度固定的只有其中的两块：Trailer和FileInfo。正如图中所示的，Trailer中有指针指向其他数 据块的起始点。</p>
<p>File Info中记录了文件的一些Meta信息，例如：AVG_KEY_LEN, AVG_VALUE_LEN, LAST_KEY, COMPARATOR, MAX_SEQ_ID_KEY等。</p>
<p>Data Index和Meta Index块记录了每个Data块和Meta块的起始点。</p>
<p>Data Block是HBase I/O的基本单元，为了提高效率，HRegionServer中有基于LRU的Block Cache机制。每个Data块的大小可以在创建一个Table的时候通过参数指定，大号的Block有利于顺序Scan，小号Block利于随机查询。 每个Data块除了开头的Magic以外就是一个个KeyValue对拼接而成, Magic内容就是一些随机数字，目的是防止数据损坏。</p>
<p>HFile里面的每个KeyValue对就是一个简单的byte数组。但是这个byte数组里面包含了很多项，并且有固定的结构。我们来看看里面的具体结构：</p>


<p>开始是两个固定长度的数值，分别表示Key的长度和Value的长度。紧接着是Key，开始是固定长度的数值，表示RowKey的长度，紧接着是 RowKey，然后是固定长度的数值，表示Family的长度，然后是Family，接着是Qualifier，然后是两个固定长度的数值，表示Time Stamp和Key Type（Put/Delete）。Value部分没有这么复杂的结构，就是纯粹的二进制数据了。</p>
<p><strong>HFile分为六个部分：</strong></p>
<p>Data Block 段–保存表中的数据，这部分可以被压缩</p>
<p>Meta Block 段 (可选的)–保存用户自定义的kv对，可以被压缩。</p>
<p>File Info 段–Hfile的元信息，不被压缩，用户也可以在这一部分添加自己的元信息。</p>
<p>Data Block Index 段–Data Block的索引。每条索引的key是被索引的block的第一条记录的key。</p>
<p>Meta Block Index段 (可选的)–Meta Block的索引。</p>
<p>Trailer–这一段是定长的。保存了每一段的偏移量，读取一个HFile时，会首先 读取Trailer，Trailer保存了每个段的起始位置(段的Magic Number用来做安全check)，然后，DataBlock Index会被读取到内存中，这样，当检索某个key时，不需要扫描整个HFile，而只需从内存中找到key所在的block，通过一次磁盘io将整个 block读取到内存中，再找到需要的key。DataBlock Index采用LRU机制淘汰。</p>
<p>HFile的Data Block，Meta Block通常采用压缩方式存储，压缩之后可以大大减少网络IO和磁盘IO，随之而来的开销当然是需要花费cpu进行压缩和解压缩。</p>
<p>目前Hfile的压缩支持两种方式：Gzip，Lzo。</p>
<h3 id="memstore与storefile"><a href="#memstore与storefile" class="headerlink" title="memstore与storefile"></a>memstore与storefile</h3><p>一个region由多个store组成，每个store包含一个列族的所有数据</p>
<p>Store包括位于内存的memstore和位于硬盘的storefile</p>
<p>写操作先写入memstore,当memstore中的数据量达到某个阈值，Hregionserver启动flashcache进程写入storefile,每次写入形成单独一个storefile</p>
<p>当storefile大小超过一定阈值后，会把当前的region分割成两个，并由Hmaster分配给相应的region服务器，实现负载均衡</p>
<p>客户端检索数据时，先在memstore找，找不到再找storefile</p>
<h3 id="HLog-WAL-log"><a href="#HLog-WAL-log" class="headerlink" title="HLog(WAL log)"></a>HLog(WAL log)</h3><p>WAL 意为Write ahead log(<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Write-ahead_logging)%EF%BC%8C%E7%B1%BB%E4%BC%BCmysql%E4%B8%AD%E7%9A%84binlog,%E7%94%A8%E6%9D%A5">http://en.wikipedia.org/wiki/Write-ahead_logging)，类似mysql中的binlog,用来</a> 做灾难恢复时用，Hlog记录数据的所有变更,一旦数据修改，就可以从log中进行恢复。</p>
<p>每个Region Server维护一个Hlog,而不是每个Region一个。这样不同region(来自不同table)的日志会混在一起，这样做的目的是不断追加单个文件相对于同时写多个文件而言，可以减少磁盘寻址次数，因此可以提高对table的写性能。带来的麻烦是，如果一台region server下线，为了恢复其上的region，需要将region server上的log进行拆分，然后分发到其它region server上进行恢复。</p>
<p>HLog文件就是一个普通的Hadoop Sequence File：</p>
<ul>
<li><p>HLog Sequence File 的Key是HLogKey对象，HLogKey中记录了写入数据的归属信息，除了table和region名字外，同时还包括 sequence number和timestamp，timestamp是”写入时间”，sequence number的起始值为0，或者是最近一次存入文件系统中sequence number。</p>
</li>
<li><p>HLog Sequece File的Value是HBase的KeyValue对象，即对应HFile中的KeyValue，可参见上文描述。</p>
</li>
</ul>
<h2 id="读写过程"><a href="#读写过程" class="headerlink" title="读写过程"></a>读写过程</h2><h3 id="读请求过程"><a href="#读请求过程" class="headerlink" title="读请求过程"></a>读请求过程</h3><p>HRegionServer保存着meta表以及表数据，要访问表数据，首先Client先去访问zookeeper，从zookeeper里面获取meta表所在的位置信息，即找到这个meta表在哪个HRegionServer上保存着。</p>
<p>接着Client通过刚才获取到的HRegionServer的IP来访问Meta表所在的HRegionServer，从而读取到Meta，进而获取到Meta表中存放的元数据。</p>
<p>Client通过元数据中存储的信息，访问对应的HRegionServer，然后扫描所在HRegionServer的Memstore和Storefile来查询数据。</p>
<p>最后HRegionServer把查询到的数据响应给Client。</p>
<p>查看meta表信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hbase(main):<span class="number">011</span>:<span class="number">0</span><span class="operator">&gt;</span> scan <span class="string">&#x27;hbase:meta&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="写请求过程"><a href="#写请求过程" class="headerlink" title="写请求过程"></a>写请求过程</h3><p>Client也是先访问zookeeper，找到Meta表，并获取Meta表元数据。</p>
<p>确定当前将要写入的数据所对应的HRegion和HRegionServer服务器。</p>
<p>Client向该HRegionServer服务器发起写入数据请求，然后HRegionServer收到请求并响应。</p>
<p>Client先把数据写入到HLog，以防止数据丢失。</p>
<p>然后将数据写入到Memstore。</p>
<p>如果HLog和Memstore均写入成功，则这条数据写入成功</p>
<p>如果Memstore达到阈值，会把Memstore中的数据flush到Storefile中。</p>
<p>当Storefile越来越多，会触发Compact合并操作，把过多的Storefile合并成一个大的HFile。</p>
<p>当HFile越来越大，Region也会越来越大，达到阈值后，会触发Split操作，将Region一分为二。</p>
<p><strong>细节描述：</strong></p>
<p>hbase使用MemStore和StoreFile存储对表的更新。</p>
<p>数据在更新时首先写入Log(WAL log)和内存(MemStore)中，MemStore中的数据是排序的，<strong>当MemStore累计到一定阈值时，就会创建一个新的MemStore</strong>，并 且将老的MemStore添加到flush队列，由单独的线程flush到磁盘上，成为一个StoreFile。于此同时，系统会在zookeeper中记录一个redo point，表示这个时刻之前的变更已经持久化了。</p>
<p>当系统出现意外时，可能导致内存(MemStore)中的数据丢失，此时使用Log(WAL log)来恢复checkpoint之后的数据。</p>
<p><strong>StoreFile是只读的，一旦创建后就不可以再修改。因此Hbase的更新其实是不断追加的操作。当一个Store中的StoreFile达到一定的阈值后，就会进行一次合并(minor_compact, major_compact),将对同一个key的修改合并到一起，形成一个大的StoreFile，当StoreFile的大小达到一定阈值后，又会对 StoreFile进行split，等分为两个StoreFile。</strong></p>
<p>由于对表的更新是不断追加的，compact时，需要访问Store中全部的 StoreFile和MemStore，将他们按row key进行合并，由于StoreFile和MemStore都是经过排序的，并且StoreFile带有内存中索引，合并的过程还是比较快。</p>
<h2 id="Region管理"><a href="#Region管理" class="headerlink" title="Region管理"></a>Region管理</h2><p><strong>region分配</strong></p>
<p>任何时刻，一个region只能分配给一个region server。master记录了当前有哪些可用的region server。以及当前哪些region分配给了哪些region server，哪些region还没有分配。当需要分配的新的region，并且有一个region server上有可用空间时，master就给这个region server发送一个装载请求，把region分配给这个region server。region server得到请求后，就开始对此region提供服务。</p>
<p><strong>region server上线</strong></p>
<p>master使用zookeeper来跟踪region server状态。当某个region server启动时，会首先在zookeeper上的server目录下建立代表自己的znode。由于master订阅了server目录上的变更消息，当server目录下的文件出现新增或删除操作时，master可以得到来自zookeeper的实时通知。因此一旦region server上线，master能马上得到消息。</p>
<p><strong>region server下线</strong></p>
<p>当region server下线时，它和zookeeper的会话断开，zookeeper而自动释放代表这台server的文件上的独占锁。master就可以确定：</p>
<ol>
<li><p>region server和zookeeper之间的网络断开了。</p>
</li>
<li><p>region server挂了。</p>
</li>
</ol>
<p>无论哪种情况，region server都无法继续为它的region提供服务了，此时master会删除server目录下代表这台region server的znode数据，并将这台region server的region分配给其它还活着的同志。</p>
<h2 id="Master工作机制"><a href="#Master工作机制" class="headerlink" title="Master工作机制"></a>Master工作机制</h2><p><strong>master上线</strong></p>
<p>master启动进行以下步骤:</p>
<ol>
<li><p>从zookeeper上<strong>获取唯一一个代表active master的锁</strong>，用来阻止其它master成为master。</p>
</li>
<li><p>扫描zookeeper上的server父节点，获得当前可用的region server列表。</p>
</li>
<li><p>和每个region server通信，获得当前已分配的region和region server的对应关系。</p>
</li>
<li><p>扫描.META.region的集合，计算得到当前还未分配的region，将他们放入待分配region列表。</p>
</li>
</ol>
<p><strong>master下线</strong></p>
<p>由于<strong>master只维护表和region的元数据</strong>，而不参与表数据IO的过程，master下线仅导致所有元数据的修改被冻结(无法创建删除表，无法修改表的schema，无法进行region的负载均衡，无法处理region 上下线，无法进行region的合并，唯一例外的是region的split可以正常进行，因为只有region server参与)，<strong>表的数据读写还可以正常进行</strong>。因此<strong>master下线短时间内对整个hbase集群没有影响</strong>。</p>
<p>从上线过程可以看到，master保存的信息全是可以冗余信息（都可以从系统其它地方收集到或者计算出来）</p>
<p>因此，一般hbase集群中总是有一个master在提供服务，还有一个以上的‘master’在等待时机抢占它的位置。</p>
<h1 id="HBase三个重要机制"><a href="#HBase三个重要机制" class="headerlink" title="HBase三个重要机制"></a>HBase三个重要机制</h1><h2 id="flush机制"><a href="#flush机制" class="headerlink" title="flush机制"></a>flush机制</h2><ol>
<li><p>**hbase.regionserver.global.memstore.size ** 默认;堆大小的40%</p>
<p>regionServer的全局memstore的大小，超过该大小会触发flush到磁盘的操作,默认是堆大小的40%,而且regionserver级别的flush会阻塞客户端读写</p>
</li>
<li><p><strong>hbase.hregion.memstore.flush.size</strong> 默认：128M</p>
<p>单个region里memstore的缓存大小，超过那么整个HRegion就会flush, </p>
</li>
<li><p><strong>hbase.regionserver.optionalcacheflushinterval</strong> 默认：1h</p>
<p>内存中的文件在自动刷新之前能够存活的最长时间</p>
</li>
<li><p><strong>hbase.regionserver.global.memstore.size.lower.limit</strong> 默认：堆大小 * 0.4 * 0.95</p>
<p>有时候集群的“写负载”非常高，写入量一直超过flush的量，这时，我们就希望memstore不要超过一定的安全设置。在这种情况下，写操作就要被阻塞一直到memstore恢复到一个“可管理”的大小, 这个大小就是默认值是堆大小 * 0.4 * 0.95，也就是当regionserver级别的flush操作发送后,会阻塞客户端写,一直阻塞到整个regionserver级别的memstore的大小为 堆大小 * 0.4 *0.95为止</p>
</li>
<li><p><strong>hbase.hregion.preclose.flush.size</strong>** 默认为：5M</p>
<p>当一个 region 中的 memstore 的大小大于这个值的时候，我们又触发 了 close.会先运行“pre-flush”操作，清理这个需要关闭的memstore，然后 将这个 region 下线。当一个 region 下线了，我们无法再进行任何写操作。 如果一个 memstore 很大的时候，flush 操作会消耗很多时间。”pre-flush” 操作意味着在 region 下线之前，会先把 memstore 清空。这样在最终执行 close 操作的时候，flush 操作会很快。</p>
</li>
<li><p><strong>hbase.hstore.compactionThreshold</strong>  默认：超过3个</p>
<p>一个store里面允许存的hfile的个数，超过这个个数会被写到新的一个hfile里面 也即是每个region的每个列族对应的memstore在fulsh为hfile的时候，默认情况下当超过3个hfile的时候就会 对这些文件进行合并重写为一个新文件，设置个数越大可以减少触发合并的时间，但是每次合并的时间就会越长</p>
</li>
</ol>
<h2 id="compact机制"><a href="#compact机制" class="headerlink" title="compact机制"></a>compact机制</h2><p>把小的storeFile文件合并成大的Storefile文件。</p>
<p>清理过期的数据，包括删除的数据</p>
<p>将数据的版本号保存为3个</p>
<h2 id="split机制"><a href="#split机制" class="headerlink" title="split机制"></a>split机制</h2><p>当Region达到阈值，会把过大的Region一分为二。</p>
<p>默认一个HFile达到10Gb的时候就会进行切分</p>
<h1 id="HBase的rowkey设计技巧"><a href="#HBase的rowkey设计技巧" class="headerlink" title="HBase的rowkey设计技巧"></a>HBase的rowkey设计技巧</h1><p>HBase是三维有序存储的，通过rowkey（行键），column key（column family和qualifier）和TimeStamp（时间戳）这个三个维度可以对HBase中的数据进行快速定位。</p>
<p>HBase中rowkey可以唯一标识一行记录，在HBase查询的时候，有以下几种方式：</p>
<ol>
<li><p>通过get方式，指定rowkey获取唯一一条记录</p>
</li>
<li><p>通过scan方式，设置startRow和stopRow参数进行范围匹配</p>
</li>
<li><p>全表扫描，即直接扫描整张表中所有行记录</p>
</li>
</ol>
<h2 id="rowkey长度原则"><a href="#rowkey长度原则" class="headerlink" title="rowkey长度原则"></a>rowkey长度原则</h2><p>rowkey是一个二进制码流，可以是任意字符串，最大长度64kb，实际应用中一般为10-100bytes，以byte[]形式保存，一般设计成定长。</p>
<p><strong>建议越短越好，不要超过16个字节</strong>，原因如下：</p>
<ul>
<li><p>数据的持久化文件HFile中是按照KeyValue存储的，如果rowkey过长，比如超过100字节，1000w行数据，光rowkey就要占用100*1000w=10亿个字节，将近1G数据，这样会极大影响HFile的存储效率；</p>
</li>
<li><p>MemStore将缓存部分数据到内存，如果rowkey字段过长，内存的有效利用率就会降低，系统不能缓存更多的数据，这样会降低检索效率。</p>
</li>
</ul>
<h2 id="rowkey散列原则"><a href="#rowkey散列原则" class="headerlink" title="rowkey散列原则"></a>rowkey散列原则</h2><p>如果rowkey按照时间戳的方式递增，不要将时间放在二进制码的前面，<strong>建议将rowkey的高位作为散列字段，由程序随机生成，低位放时间字段，这样将提高数据均衡分布在每个RegionServer，以实现负载均衡的几率</strong>。如果没有散列字段，首字段直接是时间信息，所有的数据都会集中在一个RegionServer上，这样在数据检索的时候负载会集中在个别的RegionServer上，造成热点问题，会降低查询效率。</p>
<h2 id="rowkey唯一原则"><a href="#rowkey唯一原则" class="headerlink" title="rowkey唯一原则"></a>rowkey唯一原则</h2><p>必须在设计上保证其唯一性，rowkey是按照字典顺序排序存储的，因此，设计rowkey的时候，要充分利用这个排序的特点，将<strong>经常读取的数据存储到一块，将最近可能会被访问的数据放到一块</strong>。</p>
<h2 id="什么是热点"><a href="#什么是热点" class="headerlink" title="什么是热点"></a>什么是热点</h2><p>HBase中的行是按照rowkey的字典顺序排序的，这种设计优化了scan操作，可以将相关的行以及会被一起读取的行存取在临近位置，便于scan。然而糟糕的rowkey设计是热点的源头。 </p>
<p><strong>热点发生在大量的client直接访问集群的一个或极少数个节点（访问可能是读，写或者其他操作）</strong>。大量访问会使热点region所在的单个机器超出自身承受能力，引起性能下降甚至region不可用，这也会影响同一个RegionServer上的其他region，由于主机无法服务其他region的请求。 </p>
<p>设计良好的数据访问模式以使集群被充分，均衡的利用。为了避免写热点，设计rowkey使得不同行在同一个region，但是在更多数据情况下，数据应该被写入集群的多个region，而不是一个；下面是一些常见的避免热点的方法以及它们的优缺点：</p>
<h3 id="加盐"><a href="#加盐" class="headerlink" title="加盐"></a>加盐</h3><p>这里所说的加盐不是密码学中的加盐，而是在rowkey的前面增加随机数，具体就是给rowkey分配一个随机前缀以使得它和之前的rowkey的开头不同。分配的前缀种类数量应该和你想使用数据分散到不同的region的数量一致。加盐之后的rowkey就会根据随机生成的前缀分散到各个region上，以避免热点。</p>
<h3 id="哈希"><a href="#哈希" class="headerlink" title="哈希"></a>哈希</h3><p>哈希会使同一行永远用一个前缀加盐。哈希也可以使负载分散到整个集群，但是读却是可以预测的。使用确定的哈希可以让客户端重构完整的rowkey，可以使用get操作准确获取某一个行数据。</p>
<h3 id="反转"><a href="#反转" class="headerlink" title="反转"></a>反转</h3><p><strong>第三种防止热点的方法是反转固定长度或者数字格式的rowkey</strong>。这样可以使得rowkey中经常改变的部分（最没有意义的部分）放在前面。这样可以有效的随机rowkey，但是牺牲了rowkey的有序性。</p>
<p><strong>反转rowkey的例子以手机号为rowkey，可以将手机号反转后的字符串作为rowkey，这样的就避免了以手机号那样比较固定开头导致热点问题</strong></p>
<h3 id="时间戳反转"><a href="#时间戳反转" class="headerlink" title="时间戳反转"></a>时间戳反转</h3><p>一个常见的数据处理问题是快速获取数据的最近版本，使用反转的时间戳作为rowkey的一部分对这个问题十分有用，可以用 Long.Max_Value - timestamp 追加到key的末尾，例如 [key][reverse_timestamp] , [key] 的最新值可以通过scan [key]获得[key]的第一条记录，因为HBase中rowkey是有序的，第一条记录是最后录入的数据。</p>
<p>其他一些建议：</p>
<p><strong>尽量减少行键和列族的大小在HBase中，value永远和它的key一起传输的。</strong>当具体的值在系统间传输时，它的rowkey，列名，时间戳也会一起传输。如果你的rowkey和列名很大，这个时候它们将会占用大量的存储空间。</p>
<p><strong>列族尽可能越短越好，最好是一个字符。</strong></p>
<p><strong>冗长的属性名虽然可读性好，但是更短的属性名存储在HBase中会更好。</strong></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/wjqixige/tags/hbase/" rel="tag"># hbase</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/wjqixige/2020/01/15/Scala%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%EF%BC%88%E4%B8%80%EF%BC%89/" rel="prev" title="Scala基础知识（一）">
                  <i class="fa fa-chevron-left"></i> Scala基础知识（一）
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/wjqixige/2020/01/15/Kafka%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/" rel="next" title="Kafka入门笔记">
                  Kafka入门笔记 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>





<script src="/wjqixige/js/comments.js"></script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2019 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mr.wj</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/wjqixige/js/utils.js"></script><script src="/wjqixige/js/motion.js"></script><script src="/wjqixige/js/next-boot.js"></script>

  






  





</body>
</html>
